name: Windows RDP with Tailscale

on:
  workflow_dispatch: # يمكن تشغيله يدويًا

jobs:
  setup-windows-rdp:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set environment variables
      shell: pwsh
      run: |
        echo "RDP_USER=adamuser" >> $env:GITHUB_ENV
        echo "RDP_PASS=imad22" >> $env:GITHUB_ENV
        echo "TAILSCALE_AUTH_KEY=tskey-your-auth-key" >> $env:GITHUB_ENV

    - name: Enable RDP
      shell: pwsh
      run: |
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="Remote Desktop" new enable=yes

    - name: Create user for RDP
      shell: pwsh
      run: |
        $user = $env:RDP_USER
        $pass = $env:RDP_PASS

        if ($user) {
            # حذف المستخدم إذا كان موجود لتجنب الخطأ
            if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
                Remove-LocalUser -Name $user
            }
            # إنشاء المستخدم
            net user $user $pass /add
            net localgroup administrators $user /add
            Write-Host "User $user created successfully."
        } else {
            Write-Error "RDP_USER is not set!"
            exit 1
        }

    - name: Install Tailscale
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-ipn-win.exe" -OutFile "$env:TEMP\tailscale.exe"
        Start-Process "$env:TEMP\tailscale.exe" -ArgumentList "install" -Wait

    - name: Connect Tailscale
      shell: pwsh
      run: |
        Start-Process "C:\Program Files\Tailscale IPN\tailscale.exe" -ArgumentList "up --authkey $env:TAILSCALE_AUTH_KEY" -Wait
        Start-Sleep -Seconds 10

    - name: Get Tailscale IP
      shell: pwsh
      run: |
        $tsIP = & "C:\Program Files\Tailscale IPN\tailscale.exe" ip -4
        Write-Host "=============================="
        Write-Host "Tailscale RDP Info:"
        Write-Host "IP: $tsIP"
        Write-Host "Username: $env:RDP_USER"
        Write-Host "Password: $env:RDP_PASS"
        Write-Host "=============================="
