name: Create Windows RDP with Tailscale (non-interactive)

on:
  workflow_dispatch:

jobs:
  setup-windows-rdp:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup and enable RDP via Tailscale
        shell: pwsh
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
          NEW_RDP_USER: ${{ secrets.NEW_RDP_USER || 'rdpuser' }}
          NEW_RDP_PASS: ${{ secrets.NEW_RDP_PASS || 'ChangeMe@1234' }}
        run: |
          # --- Check auth key ---
          if (-not $env:TAILSCALE_AUTHKEY -or $env:TAILSCALE_AUTHKEY.Trim() -eq "") {
            Write-Error "‚ùå Missing secret: TAILSCALE_AUTHKEY"
            exit 1
          }

          Write-Host "‚¨á Downloading latest Tailscale MSI..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-ipn-win-latest.msi"
          $out = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $out -UseBasicParsing

          Write-Host "üì¶ Installing Tailscale silently..."
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i "$out" /qn /norestart" -Wait -NoNewWindow
          Start-Sleep -Seconds 5

          # Find tailscale.exe
          $tailscaleExe = (Get-ChildItem "C:\Program Files*" -Recurse -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -eq "tailscale.exe" } |
            Select-Object -First 1).FullName

          if (-not $tailscaleExe) {
            Write-Error "‚ùå tailscale.exe not found after installation!"
            exit 1
          }

          Write-Host "‚úÖ Found Tailscale at: $tailscaleExe"

          Write-Host "üöÄ Bringing Tailscale up..."
          & $tailscaleExe up --authkey $env:TAILSCALE_AUTHKEY --accept-routes --hostname "github-rdp" | Write-Host
          Start-Sleep -Seconds 3

          Write-Host "üë§ Creating RDP user..."
          $user = $env:NEW_RDP_USER
          $pass = $env:NEW_RDP_PASS
          $secure = ConvertTo-SecureString $pass -AsPlainText -Force

          if (-not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $user -Password $secure -FullName "GitHub RDP User" -Description "Created by Workflow"
            Add-LocalGroupMember -Group "Administrators" -Member $user
          } else {
            Set-LocalUser -Name $user -Password $secure
          }

          Write-Host "üîì Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          Write-Host "üåê Checking Tailscale IP..."
          & $tailscaleExe ip

          Write-Host "`n‚úÖ Setup complete!"
          Write-Host "Use RDP to connect via the above Tailscale IP."
          Write-Host "Username: $user"
          Write-Host "Password: $pass"
