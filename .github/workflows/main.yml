name: Windows RDP + Tailscale (Stable Direct)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set credentials
        shell: pwsh
        run: |
          echo "RDP_USER=adamuser" >> $env:GITHUB_ENV
          echo "RDP_PASS=Imad22!@#" >> $env:GITHUB_ENV
          echo "TAILSCALE_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}" >> $env:GITHUB_ENV

      - name: Enable RDP and firewall
        shell: pwsh
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=yes
          Write-Host "‚úÖ RDP enabled."

      - name: Create RDP user
        shell: pwsh
        run: |
          $u=$env:RDP_USER; $p=$env:RDP_PASS
          net user $u > $null 2>&1
          if ($LASTEXITCODE -eq 0) { net user $u /delete }
          net user $u $p /add
          net localgroup administrators $u /add
          Write-Host "‚úÖ User $u created."

      - name: Install Tailscale (direct download)
        shell: pwsh
        run: |
          Write-Host "‚¨á Downloading Tailscale MSI..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi"
          $out = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $out -UseBasicParsing
          Write-Host "üõ† Installing..."
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i "$out" /qn" -Wait
          Write-Host "‚úÖ Installed Tailscale."

      - name: Start and connect Tailscale
        shell: pwsh
        run: |
          $exe = "C:\Program Files\Tailscale IPN\tailscale.exe"
          if (!(Test-Path $exe)) { Write-Error "‚ùå Tailscale not found after install!"; exit 1 }
          Write-Host "üöÄ Running tailscale up..."
          & $exe up --authkey $env:TAILSCALE_AUTH_KEY --accept-routes
          Start-Sleep -Seconds 5
          Write-Host "‚úÖ Connected to Tailscale."

      - name: Show connection info
        shell: pwsh
        run: |
          $exe = "C:\Program Files\Tailscale IPN\tailscale.exe"
          $ip = & $exe ip -4 2>$null
          if (-not $ip) { $ip = "Unknown" }
          Write-Host "üåê Your Tailscale RDP Information"
          Write-Host "----------------------------------"
          Write-Host "IP Address : $ip"
          Write-Host "Username   : $env:RDP_USER"
          Write-Host "Password   : $env:RDP_PASS"
          Write-Host "----------------------------------"
          Write-Host "Use this IP to connect via RDP (port 3389)"
