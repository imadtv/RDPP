name: Simple Windows RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  simple-rdp:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set env (use GitHub Secret for auth key)
        shell: pwsh
        run: |
          # وضع اسم المستخدم و كلمة المرور (قوية متوافقة مع سياسة Windows)
          echo "RDP_USER=adamuser" >> $env:GITHUB_ENV
          echo "RDP_PASS=Imad22!@#" >> $env:GITHUB_ENV
          # ضع مفتاح Tailscale في GitHub Secret باسم TAILSCALE_AUTH_KEY
          echo "TAILSCALE_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}" >> $env:GITHUB_ENV

      - name: Enable RDP & open firewall
        shell: pwsh
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=yes
          Write-Host "RDP enabled and firewall rules updated."

      - name: Create RDP user
        shell: pwsh
        run: |
          $user = $env:RDP_USER
          $pass = $env:RDP_PASS
          if (-not $user) { Write-Error "RDP_USER not set"; exit 1 }
          # حذف المستخدم إذا كان موجود ثم إعادة الإنشاء
          net user $user > $null 2>&1
          if ($LASTEXITCODE -eq 0) { net user $user /delete }
          net user $user $pass /add
          if ($LASTEXITCODE -ne 0) { Write-Error "Failed to create user. Check password policy."; exit 1 }
          net localgroup administrators $user /add
          Write-Host "User $user created and added to Administrators."

      - name: Install Tailscale (winget)
        shell: pwsh
        run: |
          Write-Host "Installing Tailscale via winget..."
          winget install --id Tailscale.Tailscale -e --silent --accept-package-agreements --accept-source-agreements
          if ($LASTEXITCODE -ne 0) {
            Write-Error "winget install failed. Check runner network or winget availability."
            exit 1
          }
          Write-Host "Tailscale installation attempted."

      - name: Find tailscale executable
        shell: pwsh
        run: |
          $candidates = @(
            "C:\Program Files\Tailscale IPN\tailscale.exe",
            "$env:ProgramFiles\Tailscale IPN\tailscale.exe",
            "C:\Program Files (x86)\Tailscale IPN\tailscale.exe"
          )
          $ts = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $ts) { Write-Error "Tailscale executable not found after install."; exit 1 }
          Write-Host "Found tailscale at: $ts"
          echo "TAILSCALE_EXE=$ts" >> $env:GITHUB_ENV

      - name: Start and connect Tailscale
        shell: pwsh
        run: |
          $ts = $env:TAILSCALE_EXE
          if (-not $env:TAILSCALE_AUTH_KEY) { Write-Error "TAILSCALE_AUTH_KEY secret not set!"; exit 1 }
          & $ts up --authkey $env:TAILSCALE_AUTH_KEY
          Start-Sleep -Seconds 6
          Write-Host "Tailscale up executed."

      - name: Show Tailscale IP and RDP info
        shell: pwsh
        run: |
          $ts = $env:TAILSCALE_EXE
          $ip = & $ts ip -4 2>$null
          if (-not $ip) { $ip = "Could not determine Tailscale IPv4" }
          Write-Host "===== Tailscale RDP INFO ====="
          Write-Host "Tailscale IP: $ip"
          Write-Host "RDP Username: $env:RDP_USER"
          Write-Host "RDP Password: $env:RDP_PASS"
          Write-Host "Connect using RDP to the Tailscale IP on port 3389."
          Write-Host "================================"
