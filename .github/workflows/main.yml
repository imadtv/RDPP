name: Windows RDP with Tailscale

on:
  workflow_dispatch: # يمكن تشغيله يدويًا

jobs:
  setup-windows-rdp:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set environment variables
      shell: pwsh
      run: |
        $env:RDP_USER = "adamuser"
        $env:RDP_PASS = "imad22"  # كلمة المرور التي اخترتها
        $env:TAILSCALE_AUTH_KEY = "tskey-your-auth-key"

    - name: Enable RDP
      shell: pwsh
      run: |
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="Remote Desktop" new enable=yes

    - name: Create user for RDP
      shell: pwsh
      run: |
        $user = $env:RDP_USER
        $pass = $env:RDP_PASS
        # حذف المستخدم إذا كان موجود لتجنب الخطأ
        if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $user
        }
        # إنشاء المستخدم
        net user $user $pass /add
        net localgroup administrators $user /add

    - name: Install Tailscale
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-ipn-win.exe" -OutFile "$env:TEMP\tailscale.exe"
        Start-Process "$env:TEMP\tailscale.exe" -ArgumentList "install" -Wait

    - name: Connect Tailscale
      shell: pwsh
      run: |
        Start-Process "C:\Program Files\Tailscale IPN\tailscale.exe" -ArgumentList "up --authkey $env:TAILSCALE_AUTH_KEY" -Wait
        Start-Sleep -Seconds 10

    - name: Get Tailscale IP
      shell: pwsh
      run: |
        $tsIP = & "C:\Program Files\Tailscale IPN\tailscale.exe" ip -4
        Write-Host "Tailscale RDP Info:"
        Write-Host "IP: $tsIP"
        Write-Host "Username: $env:RDP_USER"
        Write-Host "Password: $env:RDP_PASS"
